kind: Cluster
apiVersion: postgresql.cnpg.io/v1
metadata:
  name: {{ include "stakater-cloudnative-pg.fullname" . }}-cluster
  labels:
    {{- include "stakater-cloudnative-pg.labels" . | nindent 4 }}
spec:
  instances: 1
  storage:
    size: {{ .Values.cluster.storage.size }}
    #resizeInUseVolumes: True
  walStorage:
    size: {{ .Values.cluster.storage.size }}
  backup:
    retentionPolicy: "60d"
  postgresql:
    parameters:
      pgaudit.log: "all, -misc"
      pgaudit.log_catalog: "off"
      pgaudit.log_parameter: "on"
      pgaudit.log_relation: "on"
  bootstrap:
    initdb:
      owner: {{ .Values.cluster.primary.user }}
      database: {{ .Values.cluster.primary.database }}
      import:
        type: microservice
        databases:
          - {{ .Values.cluster.import.source.dbname }}
        source:
          externalCluster: import-db
  externalClusters:
    - name: import-db
      connectionParameters:
        host: {{ .Values.cluster.import.source.host }}
        user: {{ .Values.cluster.import.source.user }}
        dbname: {{ .Values.cluster.import.source.dbname }}
      password:
        name: {{ .Values.cluster.import.source.password.name }}
        key: {{ .Values.cluster.import.source.password.key }}